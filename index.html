<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kaari - Embroidery Stitch Harmony Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #fdf7f0;
            line-height: 1.5;
        }
        
        .container {
            min-height: 100vh;
            padding: 1.5rem;
            max-width: 48rem;
            margin: 0 auto;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mt-8 {
            margin-top: 2rem;
        }
        
        h1 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #7c2d12;
            margin-bottom: 0.5rem;
        }
        
        .tagline {
            color: #a8a29e;
            font-style: italic;
        }
        
        .card {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(124, 45, 18, 0.1);
            border: 1px solid #f5f5f4;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .space-y-3 > * + * {
            margin-top: 0.75rem;
        }
        
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: 0.5rem;
        }
        
        .gap-3 {
            gap: 0.75rem;
        }
        
        .gap-4 {
            gap: 1rem;
        }
        
        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #d6d3d1;
            border-radius: 0.5rem;
            font-size: 1rem;
            outline: none;
            background: white;
        }
        
        .input:focus {
            border-color: #ea580c;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }
        
        .input.error {
            border-color: #ef4444;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #ea580c;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: #dc2626;
        }
        
        .btn-secondary {
            background-color: transparent;
            color: #78716c;
            border: 1px solid #d6d3d1;
        }
        
        .btn-secondary:hover {
            background-color: #fafaf9;
            color: #57534e;
        }
        
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .select {
            padding: 0.75rem 1rem;
            border: 1px solid #d6d3d1;
            border-radius: 0.5rem;
            background: white;
            outline: none;
            width: 100%;
        }
        
        .select:focus {
            border-color: #ea580c;
            box-shadow: 0 0 0 3px rgba(234, 88, 12, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .palette-container {
            background: white;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(124, 45, 18, 0.1);
            border: 1px solid #f5f5f4;
        }
        
        .palette-stitches {
            display: flex;
            min-height: 160px;
            flex-wrap: wrap;
        }
        
        .palette-stitch {
            flex: 1;
            min-width: 150px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
            background: linear-gradient(135deg, #fef7ed 0%, #fed7aa 100%);
            border-right: 1px solid #e7e5e4;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .palette-stitch:last-child {
            border-right: none;
        }
        
        .palette-stitch:hover {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            transform: translateY(-2px);
            z-index: 10;
        }
        
        .palette-stitch.locked {
            background: linear-gradient(135deg, #ecfdf5 0%, #bbf7d0 100%);
        }
        
        .palette-stitch.locked:hover {
            background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
        }
        
        .lock-icon {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 1rem;
            height: 1rem;
            background: rgba(0,0,0,0.8);
            color: white;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        .stitch-name {
            font-weight: 600;
            color: #7c2d12;
            text-align: center;
            font-size: 0.875rem;
            line-height: 1.2;
        }
        
        .stitch-icon {
            width: 80px;
            height: 40px;
            color: #7c2d12;
            margin-bottom: 0.5rem;
        }
        
        .stitch-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stitch-difficulty {
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(124, 45, 18, 0.9);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .palette-stitch:hover .stitch-difficulty {
            opacity: 1;
        }
        
        .palette-info {
            padding: 1rem;
        }
        
        .palette-name {
            font-weight: 600;
            color: #7c2d12;
            margin-bottom: 0.5rem;
        }
        
        .palette-description {
            color: #78716c;
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }
        
        .palette-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .font-mono {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-normal {
            font-weight: normal;
        }
        
        .font-sans {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-stone-600 {
            color: #78716c;
        }
        
        .text-stone-700 {
            color: #57534e;
        }
        
        .text-stone-900 {
            color: #1c1917;
        }
        
        .text-black {
            color: #000000;
        }
        
        .underline {
            text-decoration: underline;
        }
        
        .transition {
            transition: all 0.2s;
        }
        
        .hover\:text-black:hover {
            color: #000000;
        }
        
        .hidden {
            display: none !important;
        }
        
        .message-box {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-success {
            background-color: #f0fdf4;
            color: #166534;
        }
        
        .message-error {
            background-color: #fef2f2;
            color: #991b1b;
        }
        
        .message-warning {
            background-color: #fefce8;
            color: #92400e;
        }
        
        .icon {
            width: 1rem;
            height: 1rem;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
        }
        
        .error-text {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        
        .stitch-info {
            background-color: #fef7ed;
            border: 1px solid #fed7aa;
            border-radius: 0.375rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #9a3412;
        }
        
        .stitch-info-name {
            font-weight: 600;
            color: #7c2d12;
        }
        
        .stitch-info-details {
            display: flex;
            gap: 1rem;
            margin-top: 0.25rem;
        }
        
        .stitch-info-difficulty {
            text-transform: capitalize;
        }
        
        .suggestions {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #64748b;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.875rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .card {
                padding: 1rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stitch-info-details {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .palette-stitches {
                flex-direction: column;
            }
            
            .palette-stitch {
                min-width: auto;
                border-right: none;
                border-bottom: 1px solid #e7e5e4;
            }
            
            .palette-stitch:last-child {
                border-bottom: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-center mb-8">
            <div class="text-center mb-8"><div class="text-center mb-8"><div class="text-center mb-8"> <img src="logo_kaari.png" alt="Kaari Logo" width="150" height="150"> </div>
        </div>

        <!-- Input Section -->
        <div class="mb-6 card">
            <h3 class="font-semibold text-stone-900 mb-4">Dominant Stitch</h3>
            <div class="mb-4">
                <div class="flex gap-2">
                    <input 
                        type="text" 
                        id="stitchInput" 
                        class="input" 
                        placeholder="e.g., french knot, 1, backstitch, 3"
                        oninput="validateStitch(this.value)"
                        onkeypress="handleKeyPress(event)"
                    />
                </div>
                <div id="stitchError" class="error-text hidden">
                    Stitch not found. Try: running stitch, backstitch, french knot, chain stitch, etc.
                </div>
                <div id="stitchInfo" class="stitch-info hidden">
                    <div class="stitch-info-name" id="stitchInfoName"></div>
                    <div class="stitch-info-details">
                        <div>Difficulty: <span class="stitch-info-difficulty" id="stitchInfoDifficulty"></span></div>
                        <div>Type: <span id="stitchInfoType"></span></div>
                    </div>
                </div>
                <div id="suggestions" class="suggestions">
                    Try: 1=running stitch, 2=chain stitch, 3=french knot, 4=open cretan, 5=raised chevron, 6=chevron, 7=chain stitch variant, 8=running back
                </div>
            </div>
            
            <div class="form-row">
                <div>
                    <label class="font-medium text-stone-900 mb-2" style="display: block;">Combination Size</label>
                    <select class="select" id="paletteSize">
                        <option value="3" selected>3 stitches</option>
                        <option value="4">4 stitches</option>
                        <option value="5">5 stitches</option>
                        <option value="6">6 stitches</option>
                    </select>
                </div>
                
                <div>
                    <label class="font-medium text-stone-900 mb-2" style="display: block;">Harmony Style</label>
                    <select class="select" id="themeSelect">
                        <option value="similar">Similar - Same difficulty level</option>
                        <option value="progressive">Progressive - Building complexity</option>
                        <option value="mixed">Mixed - Varied difficulties</option>
                        <option value="texture">Texture - Similar visual texture</option>
                        <option value="function">Function - Same purpose stitches</option>
                        <option value="classic">Classic - Most often seen together</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Generate Button -->
        <div class="mb-6 text-center">
            <button onclick="generateCombination()" class="btn btn-primary" id="generateBtn" disabled>
                <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Generate Combination
            </button>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold text-stone-900">Generated Combination</h3>
                <div class="text-sm text-stone-600">
                    Click stitches to lock/unlock • Locked stitches stay when regenerating
                </div>
            </div>
            
            <div id="combinationContainer" class="palette-container">
                <!-- Combination will be generated here -->
            </div>
        </div>

        <!-- Message Box -->
        <div id="messageBox" class="message-box message-success hidden">
            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span id="messageText">Combination generated successfully!</span>
        </div>
    </div>

    <script>
        // Global variables
        let dominantStitch = null;
        let currentCombination = [];
        let lockedStitches = new Set();

        // Embroidery stitch database with numbers for quick reference
        const stitchDatabase = [
            { id: 1, name: 'running stitch', difficulty: 'beginner', type: 'line', texture: 'smooth', function: 'outline', origin: 'universal', description: 'Basic forward-moving stitch, fundamental to all embroidery' },
            { id: 2, name: 'chain stitch', difficulty: 'beginner', type: 'line', texture: 'textured', function: 'outline', origin: 'asian', description: 'Looped line resembling chain links, versatile for curves' },
            { id: 3, name: 'french knot', difficulty: 'intermediate', type: 'texture', texture: 'dimensional', function: 'decorative', origin: 'european', description: 'Small raised knot perfect for texture and flower centers' },
            { id: 4, name: 'open cretan', difficulty: 'intermediate', type: 'decorative', texture: 'textured', function: 'border', origin: 'mediterranean', description: 'Open branching stitch ideal for leaves and borders' },
            { id: 5, name: 'raised chevron', difficulty: 'advanced', type: 'decorative', texture: 'dimensional', function: 'border', origin: 'european', description: 'Raised zigzag pattern with dimensional quality' },
            { id: 6, name: 'chevron', difficulty: 'intermediate', type: 'decorative', texture: 'textured', function: 'border', origin: 'european', description: 'Classic zigzag border stitch for geometric patterns' },
            { id: 7, name: 'chain stitch variant', difficulty: 'intermediate', type: 'line', texture: 'textured', function: 'outline', origin: 'asian', description: 'Variation of basic chain stitch with unique characteristics' },
            { id: 8, name: 'running back', difficulty: 'beginner', type: 'line', texture: 'smooth', function: 'outline', origin: 'universal', description: 'Running stitch worked in reverse for stronger lines' },
            { id: 9, name: 'pistil', difficulty: 'intermediate', type: 'texture', texture: 'dimensional', function: 'decorative', origin: 'european', description: 'Extended french knot resembling flower stamens' },
            { id: 10, name: 'fern', difficulty: 'intermediate', type: 'decorative', texture: 'textured', function: 'decorative', origin: 'european', description: 'Branching stitch mimicking fern fronds' },
            { id: 11, name: 'russian chain stitch', difficulty: 'advanced', type: 'line', texture: 'dimensional', function: 'outline', origin: 'russian', description: 'Ornate chain variation with twisted appearance' },
            { id: 12, name: 'cable chain', difficulty: 'intermediate', type: 'line', texture: 'dimensional', function: 'outline', origin: 'european', description: 'Chain stitch with cable-like twisted appearance' },
            { id: 13, name: 'herringbone', difficulty: 'intermediate', type: 'decorative', texture: 'textured', function: 'fill', origin: 'european', description: 'Crossed diagonal stitches forming herringbone pattern' }
        ];

        // SVG icons for each stitch pattern
        const stitchIcons = {
            'running stitch': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M10 20 L25 20 M35 20 L50 20 M60 20 L75 20 M85 20 L100 20 M110 20 L115 20" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/><circle cx="17.5" cy="20" r="1.5" fill="currentColor"/><circle cx="42.5" cy="20" r="1.5" fill="currentColor"/><circle cx="67.5" cy="20" r="1.5" fill="currentColor"/><circle cx="92.5" cy="20" r="1.5" fill="currentColor"/></svg>',
            
            'chain stitch': '<svg viewBox="0 0 120 40" class="stitch-icon"><ellipse cx="25" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="40" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="70" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="85" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/></svg>',
            
            'chain stitch variant': '<svg viewBox="0 0 120 40" class="stitch-icon"><ellipse cx="25" cy="20" rx="6" ry="10" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="40" cy="20" rx="6" ry="10" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="20" rx="6" ry="10" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="70" cy="20" rx="6" ry="10" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="85" cy="20" rx="6" ry="10" stroke="currentColor" stroke-width="3" fill="none"/><path d="M31 20 L34 20 M46 20 L49 20 M61 20 L64 20 M76 20 L79 20" stroke="currentColor" stroke-width="2"/></svg>',
            
            'french knot': '<svg viewBox="0 0 120 40" class="stitch-icon"><circle cx="20" cy="20" r="4" fill="currentColor"/><circle cx="35" cy="15" r="4" fill="currentColor"/><circle cx="50" cy="25" r="4" fill="currentColor"/><circle cx="65" cy="18" r="4" fill="currentColor"/><circle cx="80" cy="22" r="4" fill="currentColor"/><circle cx="95" cy="16" r="4" fill="currentColor"/><circle cx="110" cy="24" r="4" fill="currentColor"/></svg>',
            
            'open cretan': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M20 15 L30 20 L20 25 M30 20 L50 20 M50 15 L60 20 L50 25 M60 20 L80 20 M80 15 L90 20 L80 25 M90 20 L110 20" stroke="currentColor" stroke-width="3" fill="none" stroke-linejoin="round"/></svg>',
            
            'raised chevron': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M10 25 L25 10 L40 25 L55 10 L70 25 L85 10 L100 25 L115 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linejoin="round"/><path d="M10 30 L25 15 L40 30 L55 15 L70 30 L85 15 L100 30 L115 15" stroke="currentColor" stroke-width="3" fill="none" stroke-linejoin="round" opacity="0.7"/><circle cx="25" cy="12.5" r="2" fill="currentColor"/><circle cx="55" cy="12.5" r="2" fill="currentColor"/><circle cx="85" cy="12.5" r="2" fill="currentColor"/></svg>',
            
            'chevron': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M10 30 L25 10 L40 30 L55 10 L70 30 L85 10 L100 30 L115 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linejoin="round"/><path d="M10 10 L25 30 L40 10 L55 30 L70 10 L85 30 L100 10 L115 30" stroke="currentColor" stroke-width="3" fill="none" stroke-linejoin="round" opacity="0.7"/></svg>',
            
            'running back': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M115 20 L100 20 M90 20 L75 20 M65 20 L50 20 M40 20 L25 20 M15 20 L10 20" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round"/><circle cx="107.5" cy="20" r="1.5" fill="currentColor"/><circle cx="82.5" cy="20" r="1.5" fill="currentColor"/><circle cx="57.5" cy="20" r="1.5" fill="currentColor"/><circle cx="32.5" cy="20" r="1.5" fill="currentColor"/><path d="M120 15 L115 20 L120 25" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>',
            
            'pistil': '<svg viewBox="0 0 120 40" class="stitch-icon"><circle cx="25" cy="25" r="3" fill="currentColor"/><path d="M25 25 L25 10" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><circle cx="50" cy="28" r="3" fill="currentColor"/><path d="M50 28 L50 8" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><circle cx="75" cy="22" r="3" fill="currentColor"/><path d="M75 22 L75 12" stroke="currentColor" stroke-width="3" stroke-linecap="round"/><circle cx="100" cy="26" r="3" fill="currentColor"/><path d="M100 26 L100 6" stroke="currentColor" stroke-width="3" stroke-linecap="round"/></svg>',
            
            'fern': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M20 20 L100 20" stroke="currentColor" stroke-width="3"/><path d="M30 20 L25 10 M30 20 L25 30 M50 20 L45 12 M50 20 L45 28 M70 20 L65 8 M70 20 L65 32 M90 20 L85 14 M90 20 L85 26" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>',
            
            'russian chain stitch': '<svg viewBox="0 0 120 40" class="stitch-icon"><ellipse cx="25" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="40" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="70" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><path d="M17 20 Q25 15 33 20 Q25 25 17 20 M32 20 Q40 15 48 20 Q40 25 32 20 M47 20 Q55 15 63 20 Q55 25 47 20 M62 20 Q70 15 78 20 Q70 25 62 20" stroke="currentColor" stroke-width="2" fill="none"/></svg>',
            
            'cable chain': '<svg viewBox="0 0 120 40" class="stitch-icon"><ellipse cx="25" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="40" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="55" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><ellipse cx="70" cy="20" rx="8" ry="12" stroke="currentColor" stroke-width="3" fill="none"/><path d="M21 16 L29 24 M21 24 L29 16 M36 16 L44 24 M36 24 L44 16 M51 16 L59 24 M51 24 L59 16 M66 16 L74 24 M66 24 L74 16" stroke="currentColor" stroke-width="2"/></svg>',
            
            'herringbone': '<svg viewBox="0 0 120 40" class="stitch-icon"><path d="M10 30 L25 10 L40 30 L55 10 L70 30 L85 10 L100 30 L115 10" stroke="currentColor" stroke-width="4" fill="none" stroke-linejoin="round"/><path d="M10 10 L25 30 L40 10 L55 30 L70 10 L85 30 L100 10 L115 30" stroke="currentColor" stroke-width="3" fill="none" stroke-linejoin="round" opacity="0.7"/></svg>'
        };

        // Stitch validation and info display
        function validateStitch(input) {
            const inputField = document.getElementById('stitchInput');
            const errorDiv = document.getElementById('stitchError');
            const stitchInfoDiv = document.getElementById('stitchInfo');
            const suggestionsDiv = document.getElementById('suggestions');
            const generateBtn = document.getElementById('generateBtn');

            const normalizedInput = input.toLowerCase().trim();
            let foundStitch = null;

            // Check if input is a number
            const inputNumber = parseInt(normalizedInput);
            if (!isNaN(inputNumber)) {
                foundStitch = stitchDatabase.find(stitch => stitch.id === inputNumber);
            } else {
                // Find stitch by name (partial match)
                foundStitch = stitchDatabase.find(stitch => 
                    stitch.name.includes(normalizedInput) || normalizedInput.includes(stitch.name)
                );
            }

            if (foundStitch && normalizedInput.length > 0) {
                inputField.classList.remove('error');
                errorDiv.classList.add('hidden');
                suggestionsDiv.classList.add('hidden');
                dominantStitch = foundStitch;
                generateBtn.disabled = false;
                
                // Update stitch info display
                updateStitchInfo(foundStitch);
                stitchInfoDiv.classList.remove('hidden');
                
                return true;
            } else if (normalizedInput.length > 0) {
                inputField.classList.add('error');
                errorDiv.classList.remove('hidden');
                stitchInfoDiv.classList.add('hidden');
                suggestionsDiv.classList.remove('hidden');
                generateBtn.disabled = true;
                return false;
            } else {
                inputField.classList.remove('error');
                errorDiv.classList.add('hidden');
                stitchInfoDiv.classList.add('hidden');
                suggestionsDiv.classList.remove('hidden');
                generateBtn.disabled = true;
                return false;
            }
        }

        function updateStitchInfo(stitch) {
            document.getElementById('stitchInfoName').textContent = `${stitch.id}. ${stitch.name}`;
            document.getElementById('stitchInfoDifficulty').textContent = stitch.difficulty;
            document.getElementById('stitchInfoType').textContent = stitch.type;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !document.getElementById('generateBtn').disabled) {
                generateCombination();
            }
        }

        // Combination generation
        function generateCombination() {
            if (!dominantStitch) return;

            const size = parseInt(document.getElementById('paletteSize').value);
            const theme = document.getElementById('themeSelect').value;
            
            // Reset locks and add dominant stitch as locked
            lockedStitches.clear();
            lockedStitches.add(dominantStitch.name);

            // Generate combination
            currentCombination = createCombination(dominantStitch, theme, size);
            displayCombination();
            
            document.getElementById('resultsSection').classList.remove('hidden');
            showMessage('Combination generated successfully!', 'success');
        }

        function createCombination(dominantStitch, theme, size) {
            let availableStitches = [...stitchDatabase];
            let combination = [dominantStitch];

            // Remove locked stitches from available options
            lockedStitches.forEach(stitchName => {
                availableStitches = availableStitches.filter(s => s.name !== stitchName);
            });

            // Remove dominant stitch from available
            availableStitches = availableStitches.filter(s => s.name !== dominantStitch.name);

            // Calculate how many more stitches we need
            const remainingSlots = size - combination.length;
            let selectedStitches = [];

            if (remainingSlots > 0) {
                switch (theme) {
                    case 'similar':
                        selectedStitches = getSimilarStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'progressive':
                        selectedStitches = getProgressiveStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'mixed':
                        selectedStitches = getMixedStitches(availableStitches, remainingSlots);
                        break;
                    case 'texture':
                        selectedStitches = getTextureStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'function':
                        selectedStitches = getFunctionStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'classic':
                        selectedStitches = getClassicStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                }

                combination.push(...selectedStitches);
            }

            return combination.slice(0, size);
        }

        function getClassicStitches(dominantStitch, availableStitches, count) {
            // Define classic stitch combinations that are commonly seen together
            const classicCombinations = {
                'running stitch': ['chain stitch', 'french knot', 'running back', 'herringbone'],
                'chain stitch': ['french knot', 'running stitch', 'fern', 'pistil', 'cable chain'],
                'french knot': ['chain stitch', 'running stitch', 'pistil', 'fern', 'open cretan'],
                'open cretan': ['french knot', 'fern', 'herringbone', 'chain stitch'],
                'raised chevron': ['chevron', 'herringbone', 'chain stitch', 'cable chain'],
                'chevron': ['raised chevron', 'herringbone', 'open cretan', 'running stitch'],
                'chain stitch variant': ['chain stitch', 'cable chain', 'russian chain stitch', 'french knot'],
                'running back': ['running stitch', 'chain stitch', 'herringbone', 'french knot'],
                'pistil': ['french knot', 'fern', 'chain stitch', 'open cretan'],
                'fern': ['pistil', 'french knot', 'open cretan', 'chain stitch'],
                'russian chain stitch': ['chain stitch', 'cable chain', 'chain stitch variant', 'french knot'],
                'cable chain': ['chain stitch', 'russian chain stitch', 'chain stitch variant', 'herringbone'],
                'herringbone': ['chevron', 'open cretan', 'running stitch', 'chain stitch']
            };

            const classicPartners = classicCombinations[dominantStitch.name] || [];
            const selected = [];
            
            // First, try to get classic partners
            for (let partnerName of classicPartners) {
                if (selected.length >= count) break;
                const partner = availableStitches.find(s => s.name === partnerName);
                if (partner) {
                    selected.push(partner);
                    availableStitches = availableStitches.filter(s => s.name !== partnerName);
                }
            }
            
            // Fill remaining slots with similar function stitches
            if (selected.length < count) {
                const similarFunction = availableStitches.filter(s => s.function === dominantStitch.function);
                const remaining = count - selected.length;
                selected.push(...shuffleArray(similarFunction).slice(0, remaining));
            }
            
            return selected;
        }

        function getSimilarStitches(dominantStitch, availableStitches, count) {
            const sameDifficulty = shuffleArray(availableStitches.filter(s => s.difficulty === dominantStitch.difficulty));
            const sameType = shuffleArray(availableStitches.filter(s => s.type === dominantStitch.type && s.difficulty !== dominantStitch.difficulty));
            
            const selected = [];
            let sameDiffIndex = 0;
            let sameTypeIndex = 0;
            
            for (let i = 0; i < count; i++) {
                if (sameDiffIndex < sameDifficulty.length && Math.random() > 0.3) {
                    selected.push(sameDifficulty[sameDiffIndex]);
                    sameDiffIndex++;
                } else if (sameTypeIndex < sameType.length) {
                    selected.push(sameType[sameTypeIndex]);
                    sameTypeIndex++;
                } else if (sameDiffIndex < sameDifficulty.length) {
                    selected.push(sameDifficulty[sameDiffIndex]);
                    sameDiffIndex++;
                }
            }
            
            return selected;
        }

        function getProgressiveStitches(dominantStitch, availableStitches, count) {
            const difficultyOrder = ['beginner', 'intermediate', 'advanced'];
            const currentIndex = difficultyOrder.indexOf(dominantStitch.difficulty);
            
            const selected = [];
            let nextDifficulties = [];
            
            // Build progression
            for (let i = 0; i < count; i++) {
                const targetIndex = Math.min(currentIndex + Math.floor(i / 2) + 1, difficultyOrder.length - 1);
                const targetDifficulty = difficultyOrder[targetIndex];
                nextDifficulties.push(targetDifficulty);
            }
            
            nextDifficulties.forEach(difficulty => {
                const candidates = availableStitches.filter(s => s.difficulty === difficulty);
                if (candidates.length > 0) {
                    const randomStitch = candidates[Math.floor(Math.random() * candidates.length)];
                    selected.push(randomStitch);
                    availableStitches = availableStitches.filter(s => s.name !== randomStitch.name);
                }
            });
            
            return selected;
        }

        function getMixedStitches(availableStitches, count) {
            return shuffleArray(availableStitches).slice(0, count);
        }

        function getTextureStitches(dominantStitch, availableStitches, count) {
            const sameTexture = shuffleArray(availableStitches.filter(s => s.texture === dominantStitch.texture));
            const relatedTexture = shuffleArray(availableStitches.filter(s => s.texture !== dominantStitch.texture));
            
            const selected = [];
            let sameTextureIndex = 0;
            let relatedIndex = 0;
            
            for (let i = 0; i < count; i++) {
                if (sameTextureIndex < sameTexture.length && Math.random() > 0.3) {
                    selected.push(sameTexture[sameTextureIndex]);
                    sameTextureIndex++;
                } else if (relatedIndex < relatedTexture.length) {
                    selected.push(relatedTexture[relatedIndex]);
                    relatedIndex++;
                } else if (sameTextureIndex < sameTexture.length) {
                    selected.push(sameTexture[sameTextureIndex]);
                    sameTextureIndex++;
                }
            }
            
            return selected;
        }

        function getFunctionStitches(dominantStitch, availableStitches, count) {
            const sameFunction = shuffleArray(availableStitches.filter(s => s.function === dominantStitch.function));
            const differentFunction = shuffleArray(availableStitches.filter(s => s.function !== dominantStitch.function));
            
            const selected = [];
            let sameFunctionIndex = 0;
            let diffFunctionIndex = 0;
            
            for (let i = 0; i < count; i++) {
                if (sameFunctionIndex < sameFunction.length && Math.random() > 0.2) {
                    selected.push(sameFunction[sameFunctionIndex]);
                    sameFunctionIndex++;
                } else if (diffFunctionIndex < differentFunction.length) {
                    selected.push(differentFunction[diffFunctionIndex]);
                    diffFunctionIndex++;
                } else if (sameFunctionIndex < sameFunction.length) {
                    selected.push(sameFunction[sameFunctionIndex]);
                    sameFunctionIndex++;
                }
            }
            
            return selected;
        }

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Generate explanation for combinations
        function generateCombinationExplanation(combination, theme) {
            const explanations = {
                'similar': `These stitches share similar difficulty levels and working techniques, creating a cohesive skill progression.`,
                'progressive': `This combination builds complexity gradually, helping you develop skills step by step.`,
                'mixed': `A diverse mix of stitch types and difficulties for varied texture and visual interest.`,
                'texture': `Stitches selected for compatible visual textures that enhance each other.`,
                'function': `These stitches serve similar purposes and work well together in embroidery projects.`,
                'classic': `Time-tested stitch combinations that are traditionally used together in embroidery work.`
            };
            return explanations[theme] || 'A carefully curated combination of embroidery stitches.';
        }

        // Display combination
        function displayCombination() {
            const container = document.getElementById('combinationContainer');
            const size = parseInt(document.getElementById('paletteSize').value);
            const theme = document.getElementById('themeSelect').value;
            
            const stitchesHtml = currentCombination.map((stitch, index) => {
                const isLocked = lockedStitches.has(stitch.name);
                const icon = stitchIcons[stitch.name] || '';
                return `
                    <div class="palette-stitch ${isLocked ? 'locked' : ''}" 
                         onclick="toggleStitchLock('${stitch.name}')"
                         title="Click to ${isLocked ? 'unlock' : 'lock'} • ${stitch.description}">
                        ${isLocked ? '<div class="lock-icon">🔒</div>' : ''}
                        <div class="stitch-container">
                            ${icon}
                            <div class="stitch-name">${stitch.name}</div>
                        </div>
                        <div class="stitch-difficulty">${stitch.difficulty}</div>
                    </div>
                `;
            }).join('');

            const explanation = generateCombinationExplanation(currentCombination, theme);

            container.innerHTML = `
                <div class="palette-stitches">
                    ${stitchesHtml}
                </div>
                <div class="palette-info">
                    <div class="palette-name">${theme.charAt(0).toUpperCase() + theme.slice(1)} Combination (${currentCombination.length} stitches)</div>
                    <div class="palette-description">
                        Built around "${dominantStitch.name}" • ${lockedStitches.size} stitch${lockedStitches.size !== 1 ? 'es' : ''} locked
                    </div>
                    <div class="palette-description" style="margin-top: 0.5rem; font-style: italic; color: #57534e;">
                        ${explanation}
                    </div>
                    <div class="palette-actions">
                        <button class="btn btn-secondary btn-small" onclick="regenerateCombination()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Regenerate
                        </button>
                        <button class="btn btn-primary btn-small" onclick="saveCombination()">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2z"></path>
                            </svg>
                            Save Combination
                        </button>
                    </div>
                </div>
            `;
        }

        // Stitch locking
        function toggleStitchLock(stitchName) {
            if (lockedStitches.has(stitchName)) {
                lockedStitches.delete(stitchName);
                showMessage(`Unlocked "${stitchName}"`, 'success');
            } else {
                lockedStitches.add(stitchName);
                showMessage(`Locked "${stitchName}"`, 'success');
            }
            
            // Update display
            displayCombination();
        }

        function regenerateCombination() {
            if (!dominantStitch) return;
            
            const size = parseInt(document.getElementById('paletteSize').value);
            const theme = document.getElementById('themeSelect').value;

            // Keep locked stitches and regenerate the rest
            const lockedStitchObjects = [];
            lockedStitches.forEach(stitchName => {
                const stitchObj = stitchDatabase.find(s => s.name === stitchName);
                if (stitchObj) {
                    lockedStitchObjects.push(stitchObj);
                }
            });

            // Generate new combination preserving locked stitches
            let availableStitches = [...stitchDatabase];
            
            // Remove all locked stitches from available options
            lockedStitches.forEach(stitchName => {
                availableStitches = availableStitches.filter(s => s.name !== stitchName);
            });

            // Start with locked stitches
            let combination = [...lockedStitchObjects];
            
            // Calculate how many more stitches we need
            const remainingSlots = size - combination.length;
            let selectedStitches = [];

            if (remainingSlots > 0) {
                switch (theme) {
                    case 'similar':
                        selectedStitches = getSimilarStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'progressive':
                        selectedStitches = getProgressiveStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'mixed':
                        selectedStitches = getMixedStitches(availableStitches, remainingSlots);
                        break;
                    case 'texture':
                        selectedStitches = getTextureStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'function':
                        selectedStitches = getFunctionStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                    case 'classic':
                        selectedStitches = getClassicStitches(dominantStitch, availableStitches, remainingSlots);
                        break;
                }

                combination.push(...selectedStitches);
            }

            currentCombination = combination.slice(0, size);
            displayCombination();
            
            showMessage('Combination regenerated with locked stitches preserved!', 'success');
        }

        function saveCombination() {
            const combinationText = currentCombination.map(s => `${s.name} (${s.difficulty}) - ${s.description}`).join('\n');
            
            navigator.clipboard.writeText(combinationText).then(() => {
                showMessage('Combination copied to clipboard!', 'success');
            }).catch(() => {
                // Fallback
                const textArea = document.createElement('textarea');
                textArea.value = combinationText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showMessage('Combination copied to clipboard!', 'success');
            });
        }

        function showMessage(text, type = 'success') {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            messageText.textContent = text;
            messageBox.className = `message-box message-${type}`;
            messageBox.classList.remove('hidden');
            
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3000);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Set up initial state
            const inputField = document.getElementById('stitchInput');
            inputField.focus();
        });
    </script>
    
    <div class="text-center text-stone-700 text-sm font-normal font-sans mt-8">
        Custom-built by <a href="https://creatis.in/pages/stack" class="underline hover:text-black transition">Creatis Stack</a>, v.08.25
    </div>
</body>
</html>
